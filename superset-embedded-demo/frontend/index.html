<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superset Dashboard åµŒå…¥å¼ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1890ff;
            font-size: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .config-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-primary:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        .dashboard-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        #superset-container {
            width: 100%;
            height: calc(100vh - 400px);
            min-height: 600px;
        }

        #superset-container iframe {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 400px);
            min-height: 600px;
            color: #666;
            font-size: 16px;
        }

        .error {
            padding: 20px;
            background: #fff1f0;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            color: #cf1322;
            margin: 20px;
        }

        .info-box {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
            color: #0050b3;
        }

        .help-text {
            font-size: 12px;
            color: #8c8c8c;
            margin-top: 4px;
        }

        .warning-box {
            background: #fff7e6;
            border: 1px solid #ffd591;
            border-radius: 4px;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
            color: #d46b08;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ Superset Dashboard åµŒå…¥å¼ç¤ºä¾‹</h1>
    </div>

    <div class="container">
        <div class="config-panel">
            <h2>é…ç½®</h2>

            <div class="warning-box">
                âš ï¸ <strong>é‡è¦ï¼š</strong>æ­¤é¡µé¢éœ€è¦å…ˆä¸º Dashboard å¯ç”¨ embedded æ¨¡å¼ã€‚<br>
                ä½¿ç”¨è„šæœ¬ï¼š<code>./scripts/enable-dashboard-embedded.sh &lt;DASHBOARD_UUID&gt;</code>
            </div>

            <div class="info-box">
                ğŸ’¡ <strong>å¦‚ä½•ä½¿ç”¨ï¼š</strong><br>
                1. ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©ä¸€ä¸ª Dashboard<br>
                2. ç‚¹å‡»"å¯ç”¨ Embedded"æŒ‰é’®ï¼ˆè‡ªåŠ¨è°ƒç”¨åç«¯ APIï¼‰<br>
                3. ç­‰å¾…å¯ç”¨å®Œæˆåï¼Œç‚¹å‡»"åŠ è½½ Dashboard"
            </div>

            <div class="form-group">
                <label for="dashboard-select">é€‰æ‹© Dashboard:</label>
                <select id="dashboard-select">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <span class="help-text">é€‰æ‹©åä¼šè‡ªåŠ¨å¡«å……ä¸‹æ–¹çš„ UUID</span>
            </div>

            <div class="form-group">
                <label for="dashboard-uuid">Dashboard UUID:</label>
                <input
                    type="text"
                    id="dashboard-uuid"
                    placeholder="ä¾‹å¦‚: 6d106529-9f27-4df9-9c9e-50e036a67559"
                    readonly
                >
            </div>

            <div class="form-group">
                <label for="embedded-uuid">Embedded UUID:</label>
                <input
                    type="text"
                    id="embedded-uuid"
                    placeholder="å¯ç”¨ embedded åä¼šè‡ªåŠ¨å¡«å……"
                    readonly
                >
                <span class="help-text">ç”¨äºå‰ç«¯ embedDashboard çš„ UUID</span>
            </div>

            <div class="form-group">
                <label for="backend-url">åç«¯ API åœ°å€:</label>
                <input
                    type="text"
                    id="backend-url"
                    value="http://localhost:3001"
                >
            </div>

            <div class="form-group">
                <label for="superset-url">Superset åœ°å€:</label>
                <input
                    type="text"
                    id="superset-url"
                    value="http://localhost:8088"
                >
            </div>

            <button class="btn btn-primary" onclick="enableEmbedded()" id="enable-btn" style="margin-right: 10px;">
                å¯ç”¨ Embedded
            </button>

            <button class="btn btn-primary" onclick="loadDashboard()" id="load-btn">
                åŠ è½½ Dashboard
            </button>
        </div>

        <div class="dashboard-container">
            <div id="superset-container" class="loading">
                è¯·é€‰æ‹© Dashboard å¹¶å¯ç”¨ Embedded æ¨¡å¼
            </div>
        </div>
    </div>

    <!-- Superset Embedded SDK -->
    <script src="https://unpkg.com/@superset-ui/embedded-sdk@latest/bundle/index.js"></script>

    <script>
        const { embedDashboard } = supersetEmbeddedSdk;

        // å·²çŸ¥çš„ Embedded UUID æ˜ å°„ï¼ˆé¿å…é‡å¤å¯ç”¨ï¼‰
        const embeddedCache = {
            '6d106529-9f27-4df9-9c9e-50e036a67559': '51c5173a-ae1d-4038-b417-22a72c15bb48'
        };

        // é¡µé¢åŠ è½½æ—¶è·å–å¯ç”¨çš„ dashboards
        window.addEventListener('DOMContentLoaded', async () => {
            await loadDashboardList();
        });

        /**
         * åŠ è½½å¯ç”¨çš„ Dashboards åˆ—è¡¨
         */
        async function loadDashboardList() {
            const select = document.getElementById('dashboard-select');
            const backendUrl = document.getElementById('backend-url').value;

            try {
                const response = await fetch(`${backendUrl}/api/dashboards`);
                const data = await response.json();

                if (data.dashboards && data.dashboards.length > 0) {
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ª Dashboard</option>';
                    data.dashboards.forEach(dashboard => {
                        const option = document.createElement('option');
                        option.value = dashboard.uuid;
                        option.textContent = `${dashboard.title} (ID: ${dashboard.id})`;
                        option.dataset.title = dashboard.title;
                        select.appendChild(option);
                    });

                    // ç›‘å¬é€‰æ‹©å˜åŒ–
                    select.addEventListener('change', (e) => {
                        const dashboardUuid = e.target.value;
                        document.getElementById('dashboard-uuid').value = dashboardUuid;

                        // å¦‚æœç¼“å­˜ä¸­æœ‰ embedded UUIDï¼Œè‡ªåŠ¨å¡«å……
                        if (embeddedCache[dashboardUuid]) {
                            document.getElementById('embedded-uuid').value = embeddedCache[dashboardUuid];
                            document.getElementById('load-btn').disabled = false;
                        } else {
                            document.getElementById('embedded-uuid').value = '';
                            document.getElementById('load-btn').disabled = true;
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ° Dashboards</option>';
                }
            } catch (error) {
                console.error('Failed to load dashboards:', error);
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        /**
         * å¯ç”¨ Dashboard çš„ Embedded æ¨¡å¼
         */
        async function enableEmbedded() {
            const dashboardUuid = document.getElementById('dashboard-uuid').value.trim();
            const backendUrl = document.getElementById('backend-url').value.trim();
            const enableBtn = document.getElementById('enable-btn');

            if (!dashboardUuid) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Dashboard');
                return;
            }

            // æ£€æŸ¥ç¼“å­˜
            if (embeddedCache[dashboardUuid]) {
                document.getElementById('embedded-uuid').value = embeddedCache[dashboardUuid];
                document.getElementById('load-btn').disabled = false;
                alert('æ­¤ Dashboard å·²å¯ç”¨ Embedded æ¨¡å¼ï¼');
                return;
            }

            enableBtn.disabled = true;
            enableBtn.textContent = 'å¯ç”¨ä¸­...';

            try {
                console.log('ğŸ“Š Enabling embedded mode via backend API...');

                // è°ƒç”¨åç«¯ API å¯ç”¨ embedded
                const response = await fetch(`${backendUrl}/api/enable-embedded`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dashboardUuid: dashboardUuid
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to enable embedded mode');
                }

                const data = await response.json();
                const embeddedUuid = data.embeddedUuid;

                console.log('âœ… Embedded mode enabled:', data);

                // ä¿å­˜åˆ°ç¼“å­˜
                embeddedCache[dashboardUuid] = embeddedUuid;

                // å¡«å……åˆ°è¾“å…¥æ¡†
                document.getElementById('embedded-uuid').value = embeddedUuid;
                document.getElementById('load-btn').disabled = false;

                alert(`âœ… Embedded æ¨¡å¼å·²å¯ç”¨ï¼\n\nEmbedded UUID: ${embeddedUuid}`);
            } catch (error) {
                console.error('Failed to enable embedded:', error);
                alert('âŒ å¯ç”¨å¤±è´¥ï¼š' + error.message);
            } finally {
                enableBtn.disabled = false;
                enableBtn.textContent = 'å¯ç”¨ Embedded';
            }
        }

        /**
         * è·å– Access Tokenï¼ˆä¸å†éœ€è¦ï¼‰
         */
        async function getAccessToken(backendUrl) {
            // å·²é€šè¿‡åç«¯ API å¤„ç†
            return '';
        }

        /**
         * åŠ è½½ Dashboard
         */
        async function loadDashboard() {
            const dashboardUuid = document.getElementById('dashboard-uuid').value.trim();
            const embeddedUuid = document.getElementById('embedded-uuid').value.trim();
            const backendUrl = document.getElementById('backend-url').value.trim();
            const supersetUrl = document.getElementById('superset-url').value.trim();
            const container = document.getElementById('superset-container');
            const loadBtn = document.getElementById('load-btn');

            if (!dashboardUuid || !embeddedUuid) {
                alert('è¯·å…ˆé€‰æ‹© Dashboard å¹¶å¯ç”¨ Embedded æ¨¡å¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ Dashboard...</div>';
            loadBtn.disabled = true;
            loadBtn.textContent = 'åŠ è½½ä¸­...';

            try {
                console.log('Loading dashboard:', {
                    dashboardUuid,
                    embeddedUuid,
                    supersetUrl
                });

                // åµŒå…¥ Dashboardï¼ˆä½¿ç”¨ Embedded UUIDï¼‰
                await embedDashboard({
                    id: embeddedUuid,  // ä½¿ç”¨ Embedded UUID âœ…
                    supersetDomain: supersetUrl,
                    mountPoint: container,
                    fetchGuestToken: async () => {
                        // ä»åç«¯è·å– guest tokenï¼ˆä½¿ç”¨ Dashboard UUIDï¼‰
                        const response = await fetch(`${backendUrl}/api/guest-token`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                dashboardId: dashboardUuid,  // ä½¿ç”¨ Dashboard UUID âœ…
                                username: 'demo_user'
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Failed to get guest token');
                        }

                        const data = await response.json();
                        console.log('âœ… Guest token obtained');
                        return data.token;
                    },
                    dashboardUiConfig: {
                        hideTitle: false,
                        hideTab: false,
                        hideChartControls: false,
                        hideFilters: false,
                    },
                    debug: true
                });

                console.log('âœ… Dashboard loaded successfully');
                loadBtn.textContent = 'åŠ è½½ Dashboard';
                loadBtn.disabled = false;

            } catch (error) {
                console.error('âŒ Failed to load dashboard:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <p><strong>è¯·æ£€æŸ¥ï¼š</strong></p>
                        <ul>
                            <li>Superset æœåŠ¡æ˜¯å¦è¿è¡Œï¼ˆ${supersetUrl}ï¼‰</li>
                            <li>åç«¯ API æ˜¯å¦è¿è¡Œï¼ˆ${backendUrl}ï¼‰</li>
                            <li>Dashboard æ˜¯å¦å·²å¯ç”¨ Embedded æ¨¡å¼</li>
                            <li>Embedded UUID æ˜¯å¦æ­£ç¡®</li>
                            <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                        </ul>
                    </div>
                `;
                loadBtn.textContent = 'é‡è¯•';
                loadBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
