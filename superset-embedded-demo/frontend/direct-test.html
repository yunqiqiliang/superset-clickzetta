<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Dashboard Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .header {
            background: #20639B;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .instructions h2 {
            color: #856404;
            margin-bottom: 10px;
        }
        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        .test-frame {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        iframe {
            width: 100%;
            height: 800px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .log-panel {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .ai-message {
            color: #00ffff;
            font-weight: bold;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        button {
            background: #20639B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1a5380;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ Direct Dashboard Test (ä¸ä½¿ç”¨ Embedded SDK)</h1>
        <p>ç›´æ¥è®¿é—® Superset Dashboardï¼Œæµ‹è¯• AI Button æ¶ˆæ¯</p>
    </div>

    <div class="container">
        <div class="instructions">
            <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š</h2>
            <ol>
                <li>ä¸‹æ–¹ iframe ä¼šåŠ è½½ä½ çš„ Superset Dashboard</li>
                <li>æ‰¾åˆ° Dashboard ä¸­çš„ "AI Button Chart"</li>
                <li>ç‚¹å‡» "Ask AI" æŒ‰é’®</li>
                <li>è¾“å…¥é—®é¢˜</li>
                <li>æŸ¥çœ‹ä¸‹æ–¹çš„æ—¥å¿—é¢æ¿æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯</li>
            </ol>
            <p style="margin-top: 15px; color: #856404;">
                <strong>ğŸ’¡ æç¤ºï¼š</strong> å¦‚æœéœ€è¦ç™»å½•ï¼Œè¯·åœ¨æ–°æ ‡ç­¾é¡µç™»å½• Superset åå†åˆ·æ–°æœ¬é¡µé¢
            </p>
        </div>

        <div class="test-frame">
            <h2>ğŸ“Š Superset Dashboard</h2>
            <button onclick="reloadDashboard()">ğŸ”„ é‡æ–°åŠ è½½ Dashboard</button>
            <button onclick="openInNewTab()">ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</button>
            <div style="margin-top: 10px;">
                <iframe
                    id="dashboard-frame"
                    src="http://localhost:8088/superset/dashboard/6d106529-9f27-4df9-9c9e-50e036a67559/?standalone=3"
                ></iframe>
            </div>
        </div>

        <div class="test-frame">
            <h2>ğŸ“¨ æ¶ˆæ¯æ—¥å¿—</h2>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="testMessage()">ğŸ§ª å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <div>
                æ¶ˆæ¯æ€»æ•°: <strong id="count">0</strong> |
                AI æ¶ˆæ¯: <strong id="ai-count">0</strong>
            </div>
            <div class="log-panel" id="log">
                <div class="log-entry success">âœ… æ—¥å¿—ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…æ¶ˆæ¯...</div>
            </div>
        </div>
    </div>

    <script>
        let messageCount = 0;
        let aiMessageCount = 0;

        function log(message, className = '') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + className;

            const timestamp = new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds();
            entry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateCount() {
            document.getElementById('count').textContent = messageCount;
            document.getElementById('ai-count').textContent = aiMessageCount;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry success">âœ… æ—¥å¿—å·²æ¸…ç©º</div>';
            messageCount = 0;
            aiMessageCount = 0;
            updateCount();
        }

        function testMessage() {
            window.postMessage({
                type: 'ai-question',
                payload: 'Test message from button'
            }, '*');
            log('ğŸ§ª å‘é€æµ‹è¯•æ¶ˆæ¯', 'success');
        }

        function reloadDashboard() {
            document.getElementById('dashboard-frame').src = document.getElementById('dashboard-frame').src;
            log('ğŸ”„ é‡æ–°åŠ è½½ Dashboard', 'success');
        }

        function openInNewTab() {
            window.open('http://localhost:8088/superset/dashboard/6d106529-9f27-4df9-9c9e-50e036a67559/', '_blank');
        }

        // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            messageCount++;

            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            log(`ğŸ“ æ¥æº: ${event.origin}`);
            log(`ğŸ“¦ æ•°æ®ç±»å‹: ${typeof event.data}`);

            if (event.data && typeof event.data === 'object') {
                const dataStr = JSON.stringify(event.data, null, 2);
                log(`ğŸ“„ å®Œæ•´æ•°æ®: <pre>${dataStr}</pre>`);

                if (event.data.type === 'ai-question') {
                    aiMessageCount++;
                    log(`<strong>ğŸ‰ æ£€æµ‹åˆ° AI é—®é¢˜!</strong>`, 'ai-message');
                    log(`ğŸ’¬ é—®é¢˜å†…å®¹: "${event.data.payload}"`, 'ai-message');
                } else if (event.data.type) {
                    log(`â„¹ï¸ æ¶ˆæ¯ç±»å‹: ${event.data.type}`);
                }
            } else {
                log(`ğŸ“„ æ•°æ®: ${event.data}`);
            }

            updateCount();
        }, true);

        log('ğŸš€ å¼€å§‹ç›‘å¬ postMessage äº‹ä»¶...', 'success');
        log('ğŸ’¡ åœ¨ Dashboard ä¸­æ‰¾åˆ° "AI Button Chart" å¹¶ç‚¹å‡» "Ask AI"', 'success');
    </script>
</body>
</html>
