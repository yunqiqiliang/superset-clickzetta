<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å• AI Button æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .info {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #721c24;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        iframe {
            width: 100%;
            height: 700px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            height: 600px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-item {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }
        .log-item.ai {
            border-left-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            font-weight: bold;
        }
        .log-item.error {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }
        .log-item .time {
            color: #888;
            font-size: 11px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .stat {
            flex: 1;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª AI Button ç®€å•æµ‹è¯•é¡µé¢</h1>

        <div class="info">
            <strong>ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
            1. ç¡®ä¿ä½ å·²ç™»å½• Superset (å¦‚æœªç™»å½•ï¼Œç‚¹å‡»ä¸‹æ–¹"åœ¨æ–°çª—å£æ‰“å¼€"æŒ‰é’®å…ˆç™»å½•)<br>
            2. åœ¨å·¦ä¾§ iframe ä¸­æ‰¾åˆ° "AI Button Chart"<br>
            3. ç‚¹å‡» "Ask AI" æŒ‰é’®<br>
            4. è¾“å…¥æµ‹è¯•é—®é¢˜<br>
            5. æŸ¥çœ‹å³ä¾§æ—¥å¿—é¢æ¿çš„è¾“å‡º
        </div>

        <div class="grid">
            <!-- å·¦ä¾§ï¼šDashboard -->
            <div class="panel">
                <h2>ğŸ“Š Superset Dashboard</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="reloadDashboard()">ğŸ”„ é‡æ–°åŠ è½½</button>
                    <button onclick="openInNewWindow()">ğŸ”— åœ¨æ–°çª—å£æ‰“å¼€</button>
                </div>
                <iframe
                    id="dashboard"
                    src="http://localhost:8088/superset/dashboard/6d106529-9f27-4df9-9c9e-50e036a67559/?standalone=3"
                ></iframe>
            </div>

            <!-- å³ä¾§ï¼šæ—¥å¿— -->
            <div class="panel">
                <h2>ğŸ“¨ æ¶ˆæ¯æ—¥å¿—</h2>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="total-count">0</div>
                        <div class="stat-label">æ€»æ¶ˆæ¯</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="ai-count">0</div>
                        <div class="stat-label">AI æ¶ˆæ¯</div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                    <button onclick="testSend()">ğŸ§ª æµ‹è¯•å‘é€</button>
                </div>

                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        let totalCount = 0;
        let aiCount = 0;

        function addLog(message, type = 'normal') {
            const log = document.getElementById('log');
            const item = document.createElement('div');
            item.className = 'log-item' + (type === 'ai' ? ' ai' : type === 'error' ? ' error' : '');

            const time = new Date().toLocaleTimeString() + '.' + String(new Date().getMilliseconds()).padStart(3, '0');

            item.innerHTML = `
                <div class="time">${time}</div>
                <div>${message}</div>
            `;

            log.appendChild(item);
            log.scrollTop = log.scrollHeight;

            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (log.children.length > 100) {
                log.removeChild(log.firstChild);
            }
        }

        function updateStats() {
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('ai-count').textContent = aiCount;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            totalCount = 0;
            aiCount = 0;
            updateStats();
            addLog('âœ… æ—¥å¿—å·²æ¸…ç©º');
        }

        function reloadDashboard() {
            const iframe = document.getElementById('dashboard');
            iframe.src = iframe.src;
            addLog('ğŸ”„ é‡æ–°åŠ è½½ Dashboard');
        }

        function openInNewWindow() {
            window.open('http://localhost:8088/superset/dashboard/6d106529-9f27-4df9-9c9e-50e036a67559/', '_blank');
            addLog('ğŸ”— åœ¨æ–°çª—å£æ‰“å¼€ Dashboard');
        }

        function testSend() {
            window.postMessage({
                type: 'ai-question',
                payload: 'è¿™æ˜¯æµ‹è¯•æ¶ˆæ¯'
            }, '*');
            addLog('ğŸ§ª å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°å½“å‰çª—å£');
        }

        // ç›‘å¬æ‰€æœ‰ postMessage
        window.addEventListener('message', (event) => {
            totalCount++;

            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', event);
            console.log('  - æ¥æº:', event.origin);
            console.log('  - æ•°æ®:', event.data);

            addLog(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
            addLog(`ğŸ“ æ¥æº: ${event.origin}`);

            if (!event.data) {
                addLog('âš ï¸ ç©ºæ•°æ®');
                updateStats();
                return;
            }

            if (typeof event.data === 'string') {
                addLog(`ğŸ“„ å­—ç¬¦ä¸²æ•°æ®: ${event.data}`);
                updateStats();
                return;
            }

            if (typeof event.data === 'object') {
                // æ˜¾ç¤ºå®Œæ•´æ•°æ®ç»“æ„
                const dataStr = JSON.stringify(event.data, null, 2);
                addLog(`ğŸ“¦ å¯¹è±¡æ•°æ®:\n${dataStr}`);

                // æ£€æŸ¥æ˜¯å¦æ˜¯ AI æ¶ˆæ¯
                if (event.data.type === 'ai-question') {
                    aiCount++;
                    addLog(`ğŸ‰ æ£€æµ‹åˆ° AI é—®é¢˜!`, 'ai');

                    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾è¡¨ä¸Šä¸‹æ–‡
                    if (event.data.payload && typeof event.data.payload === 'object') {
                        addLog(`ğŸ’¬ é—®é¢˜: "${event.data.payload.question}"`, 'ai');
                        addLog(`ğŸ“Š å›¾è¡¨ID: ${event.data.payload.chartId}`, 'ai');
                        addLog(`ğŸ“‹ å›¾è¡¨åç§°: ${event.data.payload.chartName}`, 'ai');
                        addLog(`ğŸ“ Dashboard ID: ${event.data.payload.dashboardId}`, 'ai');
                        addLog(`â° æ—¶é—´: ${event.data.payload.timestamp}`, 'ai');
                    } else if (typeof event.data.payload === 'string') {
                        // å…¼å®¹æ—§æ ¼å¼
                        addLog(`ğŸ’¬ é—®é¢˜: "${event.data.payload}"`, 'ai');
                    }
                } else if (event.data.type) {
                    addLog(`â„¹ï¸ æ¶ˆæ¯ç±»å‹: ${event.data.type}`);
                }
            }

            updateStats();
        }, true);  // ä½¿ç”¨æ•è·é˜¶æ®µ

        // é¡µé¢åŠ è½½å®Œæˆ
        addLog('âœ… ç›‘å¬å™¨å·²å¯åŠ¨');
        addLog('ğŸ’¡ åœ¨ Dashboard ä¸­æ‰¾åˆ° AI Button Chart å¹¶ç‚¹å‡» Ask AI');

        // æ£€æŸ¥ iframe åŠ è½½çŠ¶æ€
        document.getElementById('dashboard').addEventListener('load', () => {
            addLog('âœ… Dashboard iframe å·²åŠ è½½');
        });

        document.getElementById('dashboard').addEventListener('error', (e) => {
            addLog('âŒ Dashboard iframe åŠ è½½å¤±è´¥: ' + e.message, 'error');
        });
    </script>
</body>
</html>
