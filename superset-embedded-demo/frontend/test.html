<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superset Embed Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        #dashboard-container {
            width: 100%;
            height: calc(100vh - 160px);
            min-height: 800px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        #dashboard-container iframe {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }
        .info {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }
        h1 {
            margin-bottom: 15px;
            color: #333;
        }

        /* éšè— embedded dashboard ä¸­çš„ç¼–è¾‘æŒ‰é’® */
        #dashboard-container iframe {
            pointer-events: auto;
        }
    </style>

    <style id="hide-edit-buttons">
        /* è¿™äº›æ ·å¼ä¼šè¢«æ³¨å…¥åˆ° iframe ä¸­ */
    </style>
</head>
<body>
    <h1>Superset Dashboard åµŒå…¥æµ‹è¯•</h1>

    <div class="info">
        <strong>æµ‹è¯• Dashboard:</strong> Insurance Fraud - Agency Level 360<br>
        <strong>Dashboard UUID:</strong> 6d106529-9f27-4df9-9c9e-50e036a67559<br>
        <strong>Embedded UUID:</strong> 51c5173a-ae1d-4038-b417-22a72c15bb48<br>
        <strong>åç«¯ API:</strong> http://localhost:3001<br>
        <strong>Superset:</strong> http://localhost:8088<br>
        <br>
        <strong style="color: #ff6b00;">âš ï¸ æ³¨æ„ï¼š</strong> æ­¤ä¸ºåªè¯»æ¨¡å¼ï¼Œç¼–è¾‘æŒ‰é’®è™½ç„¶å¯è§ä½†æ— æ³•ä½¿ç”¨ï¼ˆè¿™æ˜¯ Superset çš„å®‰å…¨è®¾è®¡ï¼‰
    </div>

    <div id="dashboard-container"></div>

    <!-- Superset Embedded SDK -->
    <script src="https://unpkg.com/@superset-ui/embedded-sdk@latest/bundle/index.js"></script>

    <script>
        console.log('Starting dashboard embed...');

        const { embedDashboard } = supersetEmbeddedSdk;

        embedDashboard({
            id: '51c5173a-ae1d-4038-b417-22a72c15bb48',  // ä½¿ç”¨ Embedded UUID
            supersetDomain: 'http://localhost:8088',
            mountPoint: document.getElementById('dashboard-container'),
            fetchGuestToken: async () => {
                console.log('Fetching guest token...');
                try {
                    const response = await fetch('http://localhost:3001/api/guest-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            dashboardId: '6d106529-9f27-4df9-9c9e-50e036a67559',  // åç«¯ä»ä½¿ç”¨ Dashboard UUID
                            username: 'test_user'
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('Failed to get guest token:', error);
                        throw new Error(error.message || 'Failed to get guest token');
                    }

                    const data = await response.json();
                    console.log('Guest token obtained successfully');
                    return data.token;
                } catch (error) {
                    console.error('Error fetching guest token:', error);
                    throw error;
                }
            },
            dashboardUiConfig: {
                hideTitle: false,
                hideTab: false,
                hideChartControls: false,
                hideFilters: false,
                // éšè—ç¼–è¾‘ç›¸å…³çš„åŠŸèƒ½
                hideEdit: true,
            },
            debug: true
        }).then(() => {
            console.log('Dashboard embedded successfully!');

            // å°è¯•éšè— iframe å†…çš„ç¼–è¾‘æŒ‰é’®ï¼ˆå¯èƒ½å—è·¨åŸŸé™åˆ¶ï¼‰
            setTimeout(() => {
                try {
                    const iframe = document.querySelector('#dashboard-container iframe');
                    if (iframe && iframe.contentWindow) {
                        const style = iframe.contentWindow.document.createElement('style');
                        style.textContent = `
                            [data-test="dashboard-edit-link"],
                            [data-test="edit-alt"],
                            button[aria-label*="Edit"],
                            button[aria-label*="edit"],
                            .ant-dropdown-trigger:has([data-test="more-horiz"]) {
                                display: none !important;
                            }
                        `;
                        iframe.contentWindow.document.head.appendChild(style);
                        console.log('âœ… Edit buttons hidden via CSS');
                    }
                } catch (e) {
                    console.warn('âš ï¸ Cannot access iframe content (CORS restriction):', e.message);
                    console.log('ğŸ’¡ Edit button will be visible but clicking it will show 403 error');
                }
            }, 2000);
        }).catch((error) => {
            console.error('Failed to embed dashboard:', error);
            document.getElementById('dashboard-container').innerHTML = `
                <div style="padding: 20px; color: red;">
                    <h3>åµŒå…¥å¤±è´¥</h3>
                    <pre>${error.message}</pre>
                </div>
            `;
        });
    </script>
</body>
</html>
